# 压测优化方案手段



## 线程数的设定

- 通过执行业务的单线程分析出本地计算时间为x
- 等待时间为y
- 系统的核数N

计算公式 : `N*(x+y)/x`



## 框架应用原则

- 兼容老的接口
- 出问题不会影响整体
- 快速下线

## 服务

1. ### 查看日志框架是否是异步插入

```xml
<appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
    <discardingThreshold>0</discardingThreshold>
    <queueSize>10000</queueSize>
    <appender-ref ref="cat"/>
    <neverBlock>true</neverBlock>
</appender>
```

如果是同步插入的话，在数据量比较大的情况下耗时比较严重。

异步： 50W ： 7s

同步：50W  ： 30s

### 2. 查看业务中是否需要异步处理的业务进行抽离

例如短信、优惠券，总的来说就是不需要返回值的统统改成异步操作。

### 3. 查看当前应用的线程数是否成为瓶颈

例如查看tomcat的最大并发数和线程数是否可以进行有效调整，接口的请求是否可以做成异步化。

### 4. 是否需要考虑引用消息队列来解耦业务实现异步化

和第二点差不多。

### 5. 考虑线程隔离

主要是为了避免一个服务出现大量流量将线程占用完了，其他服务会受到影响。

### 6. 快速失败

为了避免请求的接口耗时比较严重，而且并发比较高的情况下，会拖垮整个服务的并发以及线程数占用。

### 7. 文件IO操作使用buffer。

减少内核级调用、减少IO操作、可能减少CPU指令

### 8. 数据结构指定大小

减少扩容带来的内存占用及复制和老数据回收代理的CPU指令。

### 9. jvm调优步骤

根据gc日志计算出应用长期存活对象（老年代、永久代）的大小。

权衡合理的GC算法。

### 10. 路由设计（鉴权）

请求经过网关然后到达微服务，其中大部分是通过token来标识用户信息，而token是需要解析成具体的用户信息的，通常会放到网关去做，网关解析好了之后会带给具体的微服务去执行。

最好是之前用一张表来存储所有路由，并且通过一个对外暴露的name来访问，这个时候即便你路由发生了改变，也没有关系。



## 性能大赛优化方案

### 1. 异步通信

将同步调用设置成异步调用，使用`async-http-client`等框架以及`Servlet 3.0`提供的非阻塞API

### 2. 负载均衡优化为加权轮询

启动注册服务时，拉去服务列表同时获取每个服务的负载比例。

### 3. 非阻塞改成回调

future 方式在调用过程中不会阻塞线程，但获取结果是会阻塞线程。

替换成 callback 的好处是，io 线程专注于 io 事件，降低了线程数，这和 netty 的 io 模型也是非常契合的。







## 数据库

### 1. 首先确认大表是否有索引

这点是非常关键的，索引能够快速定位到数据。

### 2. SQL表关联是否合理，尽量将一些复杂的SQL交给业务服务去做

数据库的资源比较稀缺，尽量把复杂的操作让业务服务去处理

### 3. 查看业务中是否有统计、报表等大的表操作进行分表

通过定时任务将大的表进行汇总成一张新的表，做一些新的数据报表。

### 1. 是否有必要引入缓存来降低业务服务的压力和数据库的压力。

例如有些需要调用第三方的接口的操作，如天气、手机归属地等等。















