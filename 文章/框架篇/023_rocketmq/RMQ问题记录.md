# 常用问题记录

## 造成消息重复消费的原因?

1. 捕获的异常不对，例如抛出的是Error级别，但是业务方捕获的是Exception级别。
2. 业务方自己返回的`RECONSUME_LATER`标识，导致MQ这边执行重试逻辑。

### 排查手段

1. 查看日志，需要注意RMQ的日志位置。





### 新加入的消费组为什么总是从头开始消费?

[一个新的消费组初次启动时从何处开始消费呢](https://mp.weixin.qq.com/s?__biz=MzIzNzgyMjYxOQ==&mid=2247484375&idx=1&sn=8f9e39267c58ba7cad646f9976047e03&chksm=e8c3f423dfb47d35fd8c040aef7bf3a3b93ee06696199ea03a3d02cc0486ad4eb946978dc556&scene=0&xtrack=1&key=2d1af6f2a8440647df4fc27f7a660764d6b7a06075c5ab1d2df99bb6516132d87a2919b7852a1f61ddb0d7e2643375809d67be6ba8cda68a74ce7e79f54a872860ca5d0c031734b9ccdb5307c9ece91b&ascene=1&uin=MTc1ODIyMzMxOA%3D%3D&devicetype=Windows+10&version=62060834&lang=zh_CN&pass_ticket=a0Sf3%2FZhjVY%2FnAvsdVzGoUNdvlUXQOGN0thmKWauMwlpTmtfEohcE0kI9bO0Hsdh)

## 消息重试的设计问题

1. 生产者发送消息失败了，该如何处理？



2. 生产者发送了两条一模一样的消息，该如何过滤掉？



3. 消费者如何过滤重复消息?幂等设计?



## 消息堆积

### 当消费者跟不上生产者的速度时，该如何优化？

1. 增大topic的读写队列数量，扩充消费者，加大处理线程。
2. 批量消费模式，一次批量消费多条消息。
3. 跳过非重要的消息。
4. 优化每条消息消费过程。







# 面试

### 你们怎么保证消息中间件的高可用性?避免消息中间件故障后引发系统整体故障?

我们采用的是多M多S，数据复制是采用同步复制。

主挂了，会重新进行选举一个主的，一旦挂到最后一个S的话，只能消费消息，不能生产消息。

避免中间件故障的前提要做好:

1. 比如监控，对关于消息队列的磁盘读写以及内存的使用都要有一个很好的监控，尽量避免产生消息堆积，处理慢等等。
2. 告警: 指定合理的规则，防患于未然。一旦挂了，要有短信提醒等等。

