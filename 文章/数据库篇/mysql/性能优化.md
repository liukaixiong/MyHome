# Mysql性能监控

参考:

[ps介绍](https://www.cnblogs.com/zhoujinyi/p/5236705.html)

[mysql诊断调优常用SQL语句](https://www.jianshu.com/p/84a480235e0e)

[PS 实践文章](https://www.cnblogs.com/cchust/p/5061131.html)





Mysql中的performance_schema专门用来针对Mysql实时性能的记录反馈。

```sql
# 查看性能库是否开启
SHOW VARIABLES LIKE 'performance_schema';
```

也可以通过MySQL的配置文件`my.cnf`更改

```tex
--在配置文件中修改performance_schema的属性值，on表示开启，off表示关闭
[mysqld]
performance_schema=ON
```





## performance_schema

### 语句级别监控表

| events_statements_current                          | 当前语句事件表   |
| -------------------------------------------------- | ---------------- |
| events_statements_history                          | 历史语句事件表   |
| events_statements_history_long                     | 长语句历史事件表 |
| events_statements_summary_by_account_by_event_name | 聚合摘要帐号表   |
| events_statements_summary_by_digest                |                  |
| events_statements_summary_by_host_by_event_name    | 聚合摘要主机表   |
| events_statements_summary_by_thread_by_event_name  | 聚合摘要线程表   |
| events_statements_summary_by_user_by_event_name    |                  |
| events_statements_summary_global_by_event_name     | 聚合摘要全局表   |



#### events_statements_summary_by_digest

- **SCHEMA_NAME** : 执行的数据库名称

- **DIGEST**一个hash值，代表结构相同的一类SQL
- **DIGEST_TEXT**通过正则过滤后的SQL文本，没有具体参数值，代表结构相同的一类SQL
- **COUNT_STAR**代表这一类SQL一共执行了多少次，这是一个累积值，只有实例重启才会重置
- **SUM_TIMER_WAIT ~ SUM_NO_GOOD_INDEX_USED**这一系列的字段，都是从不同维度对SQL进行的统计，可以根据自己关注的侧重点，按需查询
  - 总执行时间 : 		**SUM_TIMER_WAIT **
  - 总执行次数: 	     **COUNT_STAR**
  - 总返回记录数:       **SUM_ROWS_SENT**
  - 总排序记录数:       **SUM_SORT_ROWS**
- **FIRST_SEEN**SQL第一次执行的时间
- **LAST_SEEN**SQL最近一次执行的时间，这个字段在收集SQL统计数据和最终生成myawr报告时都会用到

> 这里需要注意的是每个值最好是/1000000来看会比较直观

**参考样例**

```sql
SELECT
	SCHEMA_NAME AS '数据库名称',
	DIGEST_TEXT AS 'SQL样例',
	COUNT_STAR AS '执行总数',
	(AVG_TIMER_WAIT / 1000000000) AS '平均时长(秒)',
	(MAX_TIMER_WAIT / 1000000000) AS '最大时长(秒)',
	(SUM_LOCK_TIME / 1000000000) AS '平均锁等待时长(秒)',
	SUM_ROWS_SENT AS '返回行数',
	SUM_NO_INDEX_USED AS '未命中索引行数',
	LAST_SEEN
FROM
	events_statements_summary_by_digest
WHERE
	SCHEMA_NAME != 'information_schema' 
	and LAST_SEEN > date_sub(now(), interval 24 hour) 
	and DIGEST_TEXT not in ('SET `autocommit` = ? ','COMMIT ' )
and MAX_TIMER_WAIT > 1000000000
ORDER BY
	COUNT_STAR DESC;
```







### 等待事件记录表







